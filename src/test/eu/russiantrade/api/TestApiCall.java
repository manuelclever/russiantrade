package eu.russiantrade.api;

import eu.russiantrade.api.comtrade.APICall;
import eu.russiantrade.api.comtrade.ComtradeAPIParameters;
import eu.russiantrade.api.comtrade.ComtradeAPIParametersRequest;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.FileSystems;
import java.util.Properties;
import java.util.stream.Stream;

public class TestApiCall {
    @ParameterizedTest
    @MethodSource("parametersRequest")
    void callForRequest(ComtradeAPIParameters parameters, String expected) {
        try {
            System.out.println("Sleeping for 10 sec because of api rate limit...");
            Thread.sleep(10000);
        } catch(InterruptedException e) {
            Assertions.fail();
        }
        APICall apiCall = new APICall(parameters);

        //replace time in validation, else assertion will fail because point in time of apicall is different
        String regex = "\"elapsedTime\":\"[0-9.]* secs\",";
        String result = apiCall.call().replaceAll(regex,"");
        expected = expected.replaceAll(regex, "");
        Assertions.assertEquals(expected, result);
    }

    private static Stream<Arguments> parametersRequest() throws IOException {
        final String PATH = FileSystems.getDefault()
                .getPath("src", "main", "resources", "api", "api.properties")
                .toAbsolutePath().toString();

        Properties properties = new Properties();
        properties.load(new FileInputStream(PATH));
        String token = properties.getProperty("token");

        return Stream.of(
                Arguments.of(
                        ComtradeAPIParametersRequest.totalCommodities(
                                'A',
                                2010,
                                (short) 276,
                                (short) 643,
                                new String[]{"M","X"},
                                token
                                ),
                        "{\"count\":2,\"data\":[{\"typeCode\":\"C\",\"freqCode\":\"A\",\"refPeriodId\":20100101,\"refYear\":2010,\"refMonth\":52,\"period\":\"2010\",\"reporterCode\":8,\"reporterISO\":\"ALB\",\"reporterDesc\":\"Albania\",\"flowCode\":\"M\",\"flowDesc\":\"Import\",\"partnerCode\":643,\"partnerISO\":\"RUS\",\"partnerDesc\":\"Russian Federation\",\"partner2Code\":0,\"partner2ISO\":\"W00\",\"partner2Desc\":\"World\",\"classificationCode\":\"H3\",\"classificationSearchCode\":\"HS\",\"isOriginalClassification\":true,\"cmdCode\":\"TOTAL\",\"cmdDesc\":\"All Commodities\",\"aggrLevel\":0,\"isLeaf\":false,\"customsCode\":\"C00\",\"customsDesc\":\"TOTAL CPC\",\"mosCode\":\"0\",\"motCode\":0,\"motDesc\":\"TOTAL MOT\",\"qtyUnitCode\":-1,\"qtyUnitAbbr\":\"N/A\",\"qty\":null,\"isQtyEstimated\":false,\"altQtyUnitCode\":-1,\"altQtyUnitAbbr\":\"N/A\",\"altQty\":null,\"isAltQtyEstimated\":false,\"netWgt\":null,\"isNetWgtEstimated\":false,\"grossWgt\":null,\"isGrossWgtEstimated\":false,\"cifvalue\":101647050.0,\"fobvalue\":null,\"primaryValue\":101647050.0,\"legacyEstimationFlag\":0,\"isReported\":true,\"isAggregate\":false},{\"typeCode\":\"C\",\"freqCode\":\"A\",\"refPeriodId\":20100101,\"refYear\":2010,\"refMonth\":52,\"period\":\"2010\",\"reporterCode\":8,\"reporterISO\":\"ALB\",\"reporterDesc\":\"Albania\",\"flowCode\":\"X\",\"flowDesc\":\"Export\",\"partnerCode\":643,\"partnerISO\":\"RUS\",\"partnerDesc\":\"Russian Federation\",\"partner2Code\":0,\"partner2ISO\":\"W00\",\"partner2Desc\":\"World\",\"classificationCode\":\"H3\",\"classificationSearchCode\":\"HS\",\"isOriginalClassification\":true,\"cmdCode\":\"TOTAL\",\"cmdDesc\":\"All Commodities\",\"aggrLevel\":0,\"isLeaf\":false,\"customsCode\":\"C00\",\"customsDesc\":\"TOTAL CPC\",\"mosCode\":\"0\",\"motCode\":0,\"motDesc\":\"TOTAL MOT\",\"qtyUnitCode\":-1,\"qtyUnitAbbr\":\"N/A\",\"qty\":null,\"isQtyEstimated\":false,\"altQtyUnitCode\":-1,\"altQtyUnitAbbr\":\"N/A\",\"altQty\":null,\"isAltQtyEstimated\":false,\"netWgt\":null,\"isNetWgtEstimated\":false,\"grossWgt\":null,\"isGrossWgtEstimated\":false,\"cifvalue\":null,\"fobvalue\":34372.0,\"primaryValue\":34372.0,\"legacyEstimationFlag\":0,\"isReported\":true,\"isAggregate\":false}],\"error\":\"\"}"),
                Arguments.of(
                        ComtradeAPIParametersRequest.totalCommodities(
                                'M',
                                202001,
                                (short) 276,
                                (short) 643,
                                new String[]{"M","X"},
                                token),
                        "{\"validation\":{\"status\":{\"name\":\"Ok\",\"value\":0,\"category\":0,\"description\":\"\",\"helpUrl\":\"For more reference visit http://comtrade.un.org/data/dev/portal/\"},\"message\":null,\"count\":{\"value\":14,\"started\":\"0001-01-01T00:00:00\",\"finished\":\"0001-01-01T00:00:00\",\"durationSeconds\":0.0},\"datasetTimer\":{\"started\":\"2022-08-14T14:19:34.939914+02:00\",\"finished\":\"2022-08-14T14:19:34.9711702+02:00\",\"durationSeconds\":0.0312562}},\"dataset\":[{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"48\",\"cmdDescE\":\"Paper and paperboard; articles of paper pulp, of paper or paperboard\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":14,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"72\",\"cmdDescE\":\"Iron and steel\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":997226,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"84\",\"cmdDescE\":\"Nuclear reactors, boilers, machinery and mechanical appliances; parts thereof\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":210,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"85\",\"cmdDescE\":\"Electrical machinery and equipment and parts thereof; sound recorders and reproducers; television image and sound recorders and reproducers, parts and accessories of such articles\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":4085,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"90\",\"cmdDescE\":\"Optical, photographic, cinematographic, measuring, checking, medical or surgical instruments and apparatus; parts and accessories\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":10755,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"93\",\"cmdDescE\":\"Arms and ammunition; parts and accessories thereof\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":16370,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"10\",\"cmdDescE\":\"Cereals\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":9371905,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"17\",\"cmdDescE\":\"Sugars and sugar confectionery\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":34815,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"27\",\"cmdDescE\":\"Mineral fuels, mineral oils and products of their distillation; bituminous substances; mineral waxes\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":3929081,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"73\",\"cmdDescE\":\"Iron or steel articles\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":6817,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"76\",\"cmdDescE\":\"Aluminium and articles thereof\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":275813,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"87\",\"cmdDescE\":\"Vehicles; other than railway or tramway rolling stock, and parts and accessories thereof\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":5343,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"25\",\"cmdDescE\":\"Salt; sulphur; earths, stone; plastering materials, lime and cement\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":24209,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0},{\"pfCode\":\"HS\",\"yr\":2012,\"period\":201204,\"periodDesc\":\"April 2012\",\"aggrLevel\":2,\"IsLeaf\":0,\"rgCode\":1,\"rgDesc\":\"Imports\",\"rtCode\":8,\"rtTitle\":\"Albania\",\"rt3ISO\":null,\"ptCode\":643,\"ptTitle\":\"Russian Federation\",\"pt3ISO\":null,\"ptCode2\":null,\"ptTitle2\":\"\",\"pt3ISO2\":\"\",\"cstCode\":\"\",\"cstDesc\":\"\",\"motCode\":\"\",\"motDesc\":\"\",\"cmdCode\":\"69\",\"cmdDescE\":\"Ceramic products\",\"qtCode\":null,\"qtDesc\":null,\"qtAltCode\":null,\"qtAltDesc\":\"\",\"TradeQuantity\":null,\"AltQuantity\":null,\"NetWeight\":null,\"GrossWeight\":null,\"TradeValue\":186469,\"CIFValue\":null,\"FOBValue\":null,\"estCode\":0}]}")
                );
    }

}
